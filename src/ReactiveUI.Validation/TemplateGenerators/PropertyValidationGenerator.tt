<#@ template debug="false" hostspecific="false" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ output extension=".cs" #>
// <copyright file="ReactiveUI.Validation/src/ReactiveUI.Validation/TemplateGenerators/PropertyValidationGenerator.cs" company=".NET Foundation">
// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
// See the LICENSE file in the project root for more information.
// </copyright>

using System;
using System.Diagnostics.CodeAnalysis;
using System.Linq.Expressions;
using System.Reactive.Disposables;
using System.Reactive.Linq;
using System.Reactive.Subjects;
using ReactiveUI.Validation.Collections;
using ReactiveUI.Validation.Comparators;
using ReactiveUI.Validation.Components;
using ReactiveUI.Validation.States;

namespace ReactiveUI.Validation.TemplateGenerators
{
<# int maxFuncLength = 6; #>
<# for(int length=2; length <= maxFuncLength; length++) { #>
<# var templParams = Enumerable.Range(1, length).Select(x => "TProperty" + x.ToString()); #>
<# string valuePropertyParams = String.Join(", ", Enumerable.Range(1, length).Select(x => String.Format("property{0}", x))); #>

    /// <inheritdoc />
    [SuppressMessage("IDE", "SA1649", Justification = "Generated classes with template.")]
    [SuppressMessage("IDE", "SA1402", Justification = "Generated classes with template.")]
    public sealed class BasePropertyValidation<TViewModel, <#= String.Join(", ",templParams) #>>
        : BasePropertyValidation<TViewModel>
    {
        /// <summary>
        /// Represents the current value.
        /// </summary>
        private readonly Subject<Tuple<<#= String.Join(", ",templParams) #>>> _valueSubject = new Subject<Tuple<<#= String.Join(", ",templParams) #>>>();

        /// <summary>
        /// The validation message factory.
        /// </summary>
        private readonly Func<Tuple<<#= String.Join(", ",templParams) #>>, bool, ValidationText> _message;

        /// <summary>
        /// The connected observable to see updates in properties being validated.
        /// </summary>
        private readonly IConnectableObservable<Tuple<<#= String.Join(", ",templParams) #>>> _valueConnectedObservable;

        /// <summary>
        /// Function to determine if valid or not.
        /// </summary>
        private readonly Func<Tuple<<#= String.Join(", ",templParams) #>>, bool> _isValidFunc;

        private CompositeDisposable _disposables = new CompositeDisposable();

        /// <summary>
        /// The last calculated value of the properties.
        /// </summary>
        private Tuple<<#= String.Join(", ",templParams) #>> _lastValue;

        /// <summary>
        /// Are we connected.
        /// </summary>
        private bool _connected;

        /// <inheritdoc />
        public BasePropertyValidation(
            TViewModel viewModel,
    <# for(int property=1;property <= length;++property) { #>
        Expression<Func<TViewModel, TProperty<#=property#>>> property<#=property #>,<#Write("\r\n");#>
    <# } #>
        Func<Tuple<<#=String.Join(", ",templParams)#>>, bool> isValidFunc,<#Write("\r\n");#>
            Func<Tuple<<#=String.Join(", ",templParams)#>>, string> message)
            : this(viewModel, <#=String.Join(", ",valuePropertyParams)#>, isValidFunc, (p, v) => new ValidationText(v ? string.Empty : message(p)))
        {
        }

        /// <inheritdoc />
        public BasePropertyValidation(
            TViewModel viewModel,
    <# for(int property=1;property <= length;++property) { #>
        Expression<Func<TViewModel, TProperty<#=property#>>> property<#=property #>,<#Write("\r\n");#>
    <# } #>
        Func<Tuple<<#=String.Join(", ",templParams) #>>, bool> isValidFunc,
            Func<Tuple<<#=String.Join(", ",templParams)#>>, bool, string> messageFunc)
            : this(viewModel, <#=String.Join(", ",valuePropertyParams)#>, isValidFunc, (p, v) => new ValidationText(messageFunc(p, v)))
        {
        }

        /// <inheritdoc />
        public BasePropertyValidation(
            TViewModel viewModel,
    <# for(int property=1;property <= length;++property) { #>
        Expression<Func<TViewModel, TProperty<#=property#>>> property<#=property #>,<#Write("\r\n");#>
    <# } #>
        Func<Tuple<<#= String.Join(", ",templParams) #>>, bool> validSelector,
            Func<Tuple<<#= String.Join(", ",templParams) #>>, bool, ValidationText> message)
        {
            _message = message;
            _isValidFunc = validSelector;<#Write("\r\n");#><#Write("\r\n");#>
            // Add the properties used to our list
            <# for(int property=1;property<=length;property++) { #>
AddProperty(property<#=property#>);
            <#}#>
_disposables.Add(_valueSubject.Subscribe(v => _lastValue = v));

            // Setup a connected observable to see when values change and cast that to our value subject
            _valueConnectedObservable = viewModel.WhenAnyValue(<#=valuePropertyParams#>)
                .DistinctUntilChanged()
                .Multicast(_valueSubject);
        }

        /// <inheritdoc/>
        protected override IObservable<ValidationState> GetValidationChangeObservable()
        {
            Activate();

            return _valueSubject.Select(value =>
            {
                var isValid = _isValidFunc(value);
                return new ValidationState(isValid, this.GetMessage(value, isValid), this);
            }).DistinctUntilChanged(new ValidationStateComparer());
        }

        /// <inheritdoc/>
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                _disposables?.Dispose();
                _disposables = null;
            }
        }

        /// <summary>
        /// Gets the validation message.
        /// </summary>
        /// <param name="params">ViewModel properties.</param>
        /// <param name="isValid">Whether the property is valid or not.</param>
        /// <returns>Returns the <see cref="ValidationText"/> object.</returns>
        private ValidationText GetMessage(Tuple<<#=String.Join(", ",templParams)#>> @params, bool isValid)
        {
            return _message(@params, isValid);
        }

        /// <summary>
        /// Activate the connection to ensure we start seeing validations.
        /// </summary>
        private void Activate()
        {
            if (!_connected)
            {
                _connected = true;
                _disposables.Add(_valueConnectedObservable.Connect());
            }
        }
    }
<# } #>
}